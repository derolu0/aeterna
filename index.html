<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ABC Napoli F&B</title>
    
    <meta name="application-name" content="ABC Napoli F&B">
    <meta name="description" content="Gestione intelligente delle risorse idriche cittadine">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ABC Napoli F&B">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="theme-color" content="#3b82f6">
    <meta name="msapplication-TileColor" content="#3b82f6">
    
    <meta name="display" content="standalone">
    <meta name="orientation" content="portrait">
    
    <link rel="manifest" href="./manifest.json">
    
    <link rel="icon" type="image/x-icon" href="./images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="./images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./images/favicon-32x32.png">
    
    <link rel="apple-touch-icon" href="./images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./images/icona-avvio-144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./images/icona-avvio-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./images/icona-avvio-512.png">
    
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getAnalytics, setAnalyticsCollectionEnabled } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
        
        // NUOVA CONFIGURAZIONE (Aeterna Lexicon in Motu)
        const firebaseConfig = {
            apiKey: "AIzaSyBo-Fz2fb8KHlvuZmb23psKDT6QvrJowB8",
            authDomain: "aeterna-lexicon-in-motu.firebaseapp.com",
            projectId: "aeterna-lexicon-in-motu",
            storageBucket: "aeterna-lexicon-in-motu.firebasestorage.app",
            messagingSenderId: "928786632423",
            appId: "1:928786632423:web:578d45e7d6961a298d5c42",
            measurementId: "G-E70D7TDDV7"
        };
        
        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        
        // Inizializza Analytics
        const analytics = getAnalytics(app);

        // ESPORTIAMO TUTTO A LIVELLO GLOBALE (Fondamentale per app.js)
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.firebaseAnalytics = analytics; 
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.app = app;

        // Esportiamo le funzioni necessarie per il database
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.setAnalyticsCollectionEnabled = setAnalyticsCollectionEnabled;
        
        console.log('Firebase (Project Work: De Rosa) inizializzato correttamente');
    </script>
    <link rel="stylesheet" href="./style.css">

    <script>
        // Gestione scroll per ancore
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        const headerHeight = document.querySelector('header') ? document.querySelector('header').offsetHeight : 0;
                        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div id="maintenance-mode" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 99999; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
        <img src="./images/logo-app.png" alt="Logo" style="width: 100px; margin-bottom: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h1 style="color: #1f2937; margin-bottom: 10px; font-size: 1.5rem;">Sito in Manutenzione</h1>
        <p style="color: #6b7280; font-size: 1rem; max-width: 300px; margin-bottom: 30px; line-height: 1.5;">
            Stiamo aggiornando il sistema per offrirti un servizio migliore. Torneremo online a breve.
        </p>
        <button onclick="const auth=document.getElementById('admin-auth'); auth.style.display='flex'; auth.style.zIndex='100000';" style="background: #f3f4f6; border: none; padding: 10px 20px; border-radius: 50px; color: #9ca3af; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px;">
            <i class="fas fa-lock"></i> Area Riservata
        </button>
    </div>
    <div id="splash-screen">
        <div class="splash-container">
            <img src="./images/icona-avvio-splash.png" alt="ABC Napoli F&B" class="splash-image">
            <div class="splash-progress">
                <div class="splash-progress-bar"></div>
            </div>
            <p class="splash-text">Caricamento in corso...</p>
        </div>
    </div>
    
    <div class="offline-indicator" id="offline-indicator">
        <i class="fas fa-wifi"></i> Connessione assente
    </div>
    <div class="toast" id="toast"></div>

    <div class="auth-overlay" id="admin-auth">
        <div class="auth-modal">
            <h2 class="auth-title">Accesso Amministratore</h2>
            <input type="email" class="auth-input" id="admin-email" placeholder="Email">
            <input type="password" class="auth-input" id="admin-password" placeholder="Password" autocomplete="off">
            <button class="auth-btn" onclick="checkAdminAuth()">Accedi</button>
            <div class="auth-error" id="auth-error">Credenziali non valide</div>
            <button class="auth-btn secondary" onclick="closeAdminAuth()" style="background: #6b7280;">Annulla</button>
        </div>
    </div>

    <div class="modal-overlay" id="navigation-modal">
        <div class="modal-content">
            <h3 class="modal-title">Scegli l'app di navigazione</h3>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="openGoogleMaps()">
                    <i class="fas fa-map-marked-alt"></i> Google Maps
                </button>
                <button class="modal-btn primary" onclick="openAppleMaps()">
                    <i class="fas fa-map-marked-alt"></i> Apple Maps
                </button>
                <button class="modal-btn secondary" onclick="closeNavigationModal()">
                    <i class="fas fa-times"></i> Annulla
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal-content">
            <h3 class="modal-title" id="info-modal-title">Informazioni</h3>
            <p id="info-modal-message"></p>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeInfoModal()">OK</button>
            </div>
        </div>
    </div>

    <div class="admin-panel-overlay" id="admin-panel">
        <div class="admin-panel-content">
            <header class="admin-panel-header">
                <h2>Pannello di Controllo</h2>
                <button class="close-admin-panel" onclick="closeAdminPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </header>

            
            <div class="admin-tabs">
                <button class="admin-tab-btn active" data-tab="dashboard-admin">Dashboard</button>
                <button class="admin-tab-btn" data-tab="fontane-admin">Fontane</button>
                <button class="admin-tab-btn" data-tab="beverini-admin">Beverini</button>
                <button class="admin-tab-btn" data-tab="news-admin">News</button>
                <button class="admin-tab-btn" data-tab="analytics-admin">Analytics</button>
                <button class="admin-tab-btn" data-tab="config-admin">Configurazione</button>
            </div>

            <div class="admin-tab-content active" id="dashboard-admin">
                <div class="dashboard-stats">
                    <div class="stat-card fontane">
                        <div class="stat-title">Fontane Totali</div>
                        <div class="stat-value" id="total-fontane">0</div>
                        <div class="stat-details">
                            <div class="stat-detail">
                                <div class="detail-value status-funzionante" id="fontane-funzionanti">0</div>
                                <div class="detail-label">Funzionanti</div>
                            </div>
                            <div class="stat-detail">
                                <div class="detail-value status-non-funzionante" id="fontane-non-funzionanti">0</div>
                                <div class="detail-label">Non Funzionanti</div>
                            </div>
                            <div class="stat-detail">
                                <div class="detail-value status-manutenzione" id="fontane-manutenzione">0</div>
                                <div class="detail-label">In Manutenzione</div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card beverini">
                        <div class="stat-title">Beverini Totali</div>
                        <div class="stat-value" id="total-beverini">0</div>
                        <div class="stat-details">
                            <div class="stat-detail">
                                <div class="detail-value status-funzionante" id="beverini-funzionanti">0</div>
                                <div class="detail-label">Funzionanti</div>
                            </div>
                            <div class="stat-detail">
                                <div class="detail-value status-non-funzionante" id="beverini-non-funzionanti">0</div>
                                <div class="detail-label">Non Funzionanti</div>
                            </div>
                            <div class="stat-detail">
                                <div class="detail-value status-manutenzione" id="beverini-manutenzione">0</div>
                                <div class="detail-label">In Manutenzione</div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card news">
                        <div class="stat-title">News Totali</div>
                        <div class="stat-value" id="total-news">0</div>
                    </div>
                </div>

                <div class="recent-activity">
                    <div class="activity-title">
                        <span>Attività Recenti</span>
                        <button class="admin-btn secondary" onclick="clearActivityLog()">
                            <i class="fas fa-trash"></i> Pulisci
                        </button>
                    </div>
                    <div class="activity-list" id="activity-list">
                    </div>
                </div>
            </div>

            <div class="admin-tab-content" id="fontane-admin">
                <div class="import-export-section">
                    <h4>Import/Export Fontane</h4>
                    <div class="import-options">
                        <input type="file" id="import-fontane-file" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFileImport('fontane', this.files)">
                        <button class="admin-btn secondary" onclick="document.getElementById('import-fontane-file').click()">
                            <i class="fas fa-file-import"></i> Importa Fontane
                        </button>
                        <button class="admin-btn secondary" onclick="exportDataToExcel('fontane')">
                            <i class="fas fa-file-export"></i> Esporta Fontane
                        </button>
                        <button class="admin-btn secondary" onclick="downloadTemplate('fontane')">
                            <i class="fas fa-download"></i> Template Fontane
                        </button>
                    </div>
                </div>

                <h3>Aggiungi/Modifica Fontana</h3>
                <form id="fontana-form" onsubmit="saveFontana(event)">
                    <input type="hidden" id="fontana-id">
                    <div class="form-group">
                        <label for="fontana-nome">Nome Filosofo:</label>
                        <input type="text" id="fontana-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="fontana-nome-en" style="color: #3b82f6; font-style: italic;">Nome (Inglese)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="fontana-nome-en" placeholder="Name in English" style="background: #f0f9ff; border-color: #bae6fd; flex: 1;">
                            <button type="button" class="admin-btn secondary" onclick="autoTranslate('fontana-nome', 'fontana-nome-en')" style="padding: 0 10px;" title="Traduci automaticamente">✨</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fontana-indirizzo">Luogo di Nascita / Opera:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                            <input type="text" id="fontana-indirizzo" required style="flex: 1;">
                            <button type="button" class="location-btn secondary" onclick="getCurrentLocationWithAddress('fontana')"
                                    title="Usa la posizione corrente per coordinate e indirizzo">
                                <i class="fas fa-location-arrow"></i> Rileva Automatico
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fontana-stato">Epoca (Stato):</label>
                        <select id="fontana-stato" required>
                            <option value="funzionante">Contemporaneo (1900-oggi) [Blu]</option>
                            <option value="non-funzionante">Classico (Antico) [Oro]</option>
                            <option value="manutenzione">Moderno (1500-1800) [Viola]</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fontana-anno">Anno:</label>
                        <input type="text" id="fontana-anno">
                    </div>
                    <div class="form-group">
                        <label for="fontana-descrizione">Descrizione</label>
                        <textarea id="fontana-descrizione" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fontana-descrizione-en" style="color: #3b82f6; font-style: italic;">Descrizione (Inglese)</label>
                        <div style="display: flex; gap: 5px; align-items: flex-start;">
                            <textarea id="fontana-descrizione-en" rows="3" placeholder="Description in English" style="background: #f0f9ff; border-color: #bae6fd; flex: 1;"></textarea>
                            <button type="button" class="admin-btn secondary" onclick="autoTranslate('fontana-descrizione', 'fontana-descrizione-en')" style="padding: 10px;" title="Traduci automaticamente">✨</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fontana-storico">Storico:</label>
                        <textarea id="fontana-storico" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fontana-storico-en" style="color: #3b82f6; font-style: italic;">Storico (Inglese)</label>
                        <div style="display: flex; gap: 5px; align-items: flex-start;">
                            <textarea id="fontana-storico-en" rows="3" placeholder="History in English" style="background: #f0f9ff; border-color: #bae6fd; flex: 1;"></textarea>
                            <button type="button" class="admin-btn secondary" onclick="autoTranslate('fontana-storico', 'fontana-storico-en')" style="padding: 10px;" title="Traduci automaticamente">✨</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fontana-latitudine">Coordinate:</label>
                        <div style="margin-bottom: 8px;">
                            <div class="location-buttons">
                                <button type="button" class="location-btn primary" onclick="getCurrentLocationCoordinatesOnly('fontana')">
                                    <i class="fas fa-location-arrow"></i> Solo Coordinate
                                </button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 0.8rem; color: var(--light-text);">Latitudine</label>
                                <input type="text" id="fontana-latitudine" required placeholder="40.8518">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--light-text);">Longitudine</label>
                                <input type="text" id="fontana-longitudine" required placeholder="14.2681">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fontana-immagine">URL Immagine:</label>
                        <input type="text" id="fontana-immagine">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="admin-btn primary">Salva</button>
                        <button type="button" class="admin-btn secondary" onclick="resetFontanaForm()">Annulla</button>
                    </div>
                </form>

                <div class="admin-table-actions" style="margin-bottom: 10px; display: flex; justify-content: flex-end;">
                    <button id="btn-delete-sel-fontane" class="delete-selected-btn" onclick="deleteSelectedItems('fontane')" disabled>
                        <i class="fas fa-trash"></i> Elimina Selezionati (0)
                    </button>
                </div>

                <div class="admin-table-container">
                    <table class="admin-table" id="fontane-table">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" onchange="toggleSelectAll('fontane', this)">
                                </th>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Indirizzo</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="fontane-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-tab-content" id="beverini-admin">
                <div class="import-export-section">
                    <h4>Import/Export Beverini</h4>
                    <div class="import-options">
                        <input type="file" id="import-beverini-file" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFileImport('beverini', this.files)">
                        <button class="admin-btn secondary" onclick="document.getElementById('import-beverini-file').click()">
                            <i class="fas fa-file-import"></i> Importa Beverini
                        </button>
                        <button class="admin-btn secondary" onclick="exportDataToExcel('beverini')">
                            <i class="fas fa-file-export"></i> Esporta Beverini
                        </button>
                        <button class="admin-btn secondary" onclick="downloadTemplate('beverini')">
                            <i class="fas fa-download"></i> Template Beverini
                        </button>
                    </div>
                </div>

                <h3>Aggiungi/Modifica Beverino</h3>
                <form id="beverino-form" onsubmit="saveBeverino(event)">
                    <input type="hidden" id="beverino-id">
                    <div class="form-group">
                        <label for="beverino-nome">Nome Concetto:</label>
                        <input type="text" id="beverino-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="beverino-nome-en" style="color: #3b82f6; font-style: italic;">Nome (Inglese)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="beverino-nome-en" placeholder="Name in English" style="background: #f0f9ff; border-color: #bae6fd; flex: 1;">
                            <button type="button" class="admin-btn secondary" onclick="autoTranslate('beverino-nome', 'beverino-nome-en')" style="padding: 0 10px;" title="Traduci automaticamente">✨</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="beverino-indirizzo">Titolo Opera:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                            <input type="text" id="beverino-indirizzo" required style="flex: 1;">
                            <button type="button" class="location-btn secondary" onclick="getCurrentLocationWithAddress('beverino')"
                                    title="Usa la posizione corrente per coordinate e indirizzo">
                                <i class="fas fa-location-arrow"></i> Rileva Automatico
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="beverino-stato">Epoca (Stato):</label>
                        <select id="beverino-stato" required>
                            <option value="funzionante">Contemporaneo (1900-oggi) [Blu]</option>
                            <option value="non-funzionante">Classico (Antico) [Oro]</option>
                            <option value="manutenzione">Moderno (1500-1800) [Viola]</option>
                         </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="beverino-descrizione">Descrizione:</label>
                        <textarea id="beverino-descrizione" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="beverino-descrizione-en" style="color: #3b82f6; font-style: italic;">Descrizione (Inglese)</label>
                        <div style="display: flex; gap: 5px; align-items: flex-start;">
                            <textarea id="beverino-descrizione-en" rows="3" placeholder="Description in English" style="background: #f0f9ff; border-color: #bae6fd; flex: 1;"></textarea>
                            <button type="button" class="admin-btn secondary" onclick="autoTranslate('beverino-descrizione', 'beverino-descrizione-en')" style="padding: 10px;" title="Traduci automaticamente">✨</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="beverino-latitudine">Coordinate:</label>
                        <div style="margin-bottom: 8px;">
                            <div class="location-buttons">
                                <button type="button" class="location-btn primary" onclick="getCurrentLocationCoordinatesOnly('beverino')">
                                    <i class="fas fa-location-arrow"></i> Solo Coordinate
                                </button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 0.8rem; color: var(--light-text);">Latitudine</label>
                                <input type="text" id="beverino-latitudine" required placeholder="40.8518">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--light-text);">Longitudine</label>
                                <input type="text" id="beverino-longitudine" required placeholder="14.2681">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="beverino-immagine">URL Immagine:</label>
                        <input type="text" id="beverino-immagine">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="admin-btn primary">Salva</button>
                        <button type="button" class="admin-btn secondary" onclick="resetBeverinoForm()">Annulla</button>
                    </div>
                </form>

                <div class="admin-table-actions" style="margin-bottom: 10px; display: flex; justify-content: flex-end;">
                    <button id="btn-delete-sel-beverini" class="delete-selected-btn" onclick="deleteSelectedItems('beverini')" disabled>
                        <i class="fas fa-trash"></i> Elimina Selezionati (0)
                    </button>
                </div>

                <div class="admin-table-container">
                    <table class="admin-table" id="beverini-table">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" onchange="toggleSelectAll('beverini', this)">
                                </th>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Indirizzo</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="beverini-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-tab-content" id="news-admin">
                <div class="import-export-section">
                    <h4>Import/Export News</h4>
                    <div class="import-options">
                        <input type="file" id="import-news-file" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFileImport('news', this.files)">
                        <button class="admin-btn secondary" onclick="document.getElementById('import-news-file').click()">
                            <i class="fas fa-file-import"></i> Importa News
                        </button>
                        <button class="admin-btn secondary" onclick="exportDataToExcel('news')">
                            <i class="fas fa-file-export"></i> Esporta News
                        </button>
                        <button class="admin-btn secondary" onclick="downloadTemplate('news')">
                            <i class="fas fa-download"></i> Template News
                        </button>
                    </div>
                </div>

                <h3 class="admin-section-title">Gestione Glossario</h3>
                <form id="news-form" onsubmit="saveNews(event)">
                    <input type="hidden" id="news-id">

                    <div class="form-group">
                        <label for="news-titolo">Termine (es. Arché):</label>
                        <input type="text" id="news-titolo" required placeholder="Inserisci il termine filosofico">
                    </div>

                    <div class="form-group">
                         <label for="news-titolo-en" style="color: var(--primary-blue); font-style: italic;">Termine (Inglese)</label>
                         <div style="display: flex; gap: 5px;">
                             <input type="text" id="news-titolo-en" placeholder="Translation..." style="flex: 1;">
                             <button type="button" class="admin-btn secondary" onclick="autoTranslate('news-titolo', 'news-titolo-en')" title="Traduci con AI">✨</button>
                         </div>
                     </div>

                     <div class="form-group">
                        <label for="news-contenuto">Definizione:</label>
                        <textarea id="news-contenuto" rows="4" required placeholder="Scrivi la definizione tecnica..."></textarea>
                     </div>

                     <div class="form-group">
                         <label for="news-contenuto-en" style="color: var(--primary-blue); font-style: italic;">Definizione (Inglese)</label>
                         <div style="display: flex; gap: 5px; align-items: flex-start;">
                             <textarea id="news-contenuto-en" rows="4" placeholder="English definition..." style="flex: 1;"></textarea>
                             <button type="button" class="admin-btn secondary" onclick="autoTranslate('news-contenuto', 'news-contenuto-en')" style="padding: 10px;" title="Traduci con AI">✨</button>
                         </div>
                     </div>

                     <div class="form-group">
                         <div style="display: flex; gap: 15px;">
                         <div style="flex: 1;">
                             <label for="news-data">Data:</label>
                             <input type="date" id="news-data" required>
                         </div>
                         <div style="flex: 1;">
                             <label for="news-categoria">Categoria:</label>
                             <input type="text" id="news-categoria" placeholder="es. Metafisica">
                         </div>
                     </div>
                 </div>

                 <div class="form-group">
                     <label for="news-fonte">Riferimento / Autore:</label>
                     <input type="text" id="news-fonte" required placeholder="es. Aristotele, Libro V">
                 </div>

                 <div class="form-actions">
                     <button type="submit" class="admin-btn primary">Salva Definizione</button>
                     <button type="button" class="admin-btn secondary" onclick="resetNewsForm()">Annulla</button>
                 </div>
             </form>

                <div class="admin-table-actions" style="margin-bottom: 10px; display: flex; justify-content: flex-end;">
                    <button id="btn-delete-sel-news" class="delete-selected-btn" onclick="deleteSelectedItems('news')" disabled>
                        <i class="fas fa-trash"></i> Elimina Selezionati (0)
                    </button>
                </div>

                <div class="admin-table-container">
                    <table class="admin-table" id="news-table">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" onchange="toggleSelectAll('news', this)">
                                </th>
                                <th>ID</th>
                                <th>Titolo</th>
                                <th>Data</th>
                                <th>Categoria</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="news-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-tab-content" id="analytics-admin">
                <div class="analytics-header">
                    <h3>Dashboard Analytics</h3>
                    <p>Monitora le attività degli utenti e le prestazioni dell'app</p>
                </div>
                
                <div class="analytics-stats-grid">
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon" style="background: var(--primary-blue);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="analytics-stat-value" id="analytics-session-count">0</div>
                        <div class="analytics-stat-label">Sessioni Oggi</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon" style="background: var(--primary-green);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="analytics-stat-value" id="analytics-events-count">0</div>
                        <div class="analytics-stat-label">Eventi Oggi</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon" style="background: var(--primary-purple);">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="analytics-stat-value" id="analytics-pageviews-count">0</div>
                        <div class="analytics-stat-label">Page Views</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon" style="background: var(--primary-red);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="analytics-stat-value" id="analytics-errors-count">0</div>
                        <div class="analytics-stat-label">Errori Oggi</div>
                    </div>
                </div>
                
                <div class="analytics-charts-section">
                    <div class="analytics-chart-container">
                        <h4>Attività Utenti (Ultimi 7 giorni)</h4>
                        <canvas id="activity-chart"></canvas>
                        <div class="performance-metrics">
                            <div class="performance-metric">
                                <span class="metric-label">Tempo medio caricamento pagine:</span>
                                <span class="metric-value" id="metric-page-load">0ms</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Tempo medio caricamento immagini:</span>
                                <span class="metric-value" id="metric-image-load">0ms</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Tempo medio caricamento dati:</span>
                                <span class="metric-value" id="metric-data-load">0ms</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-chart-container">
                        <h4>Stato Sistema</h4>
                        <div class="analytics-status">
                            <div class="status-indicator" id="analytics-status-indicator">
                                <i class="fas fa-circle"></i>
                                <span id="analytics-status-text">Analytics Attivo</span>
                            </div>
                            <div class="session-info">
                                <div>Session ID: <code id="current-session-id">...</code></div>
                                <div>User ID: <code id="current-user-id">...</code></div>
                                <div>Ultimo sync: <span id="last-sync-time">Mai</span></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px;">
                            <h5 style="margin-bottom: 10px;">Storage Utilizzato</h5>
                            <div class="performance-metric">
                                <span class="metric-label">Eventi archiviati:</span>
                                <span class="metric-value" id="storage-events">0</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Errori archiviati:</span>
                                <span class="metric-value" id="storage-errors">0</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Storage totale:</span>
                                <span class="metric-value" id="storage-used">0 KB</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-tables-section">
                    <div class="analytics-table-container">
                        <h4>Errori Recenti</h4>
                        <div class="analytics-table">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Data/Ora</th>
                                        <th>Contesto</th>
                                        <th>Messaggio</th>
                                        <th>Severità</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-errors-table">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="analytics-table-container">
                        <h4>Eventi Più Frequenti</h4>
                        <div class="analytics-table">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Categoria</th>
                                        <th>Azione</th>
                                        <th>Conteggio</th>
                                        <th>Ultimo</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-events-table">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-actions-section">
                    <h4>Azioni Analytics</h4>
                    <div class="analytics-actions">
                        <button class="admin-btn primary" onclick="refreshAnalyticsDashboard()">
                            <i class="fas fa-sync-alt"></i> Aggiorna Dashboard
                        </button>
                        <button class="admin-btn secondary" onclick="exportAnalyticsData()">
                            <i class="fas fa-download"></i> Esporta Dati
                        </button>
                        <button class="admin-btn secondary" onclick="toggleAnalyticsTracking()">
                            <i class="fas fa-toggle-on"></i> Attiva/Disattiva
                        </button>
                        <button class="admin-btn danger" onclick="resetAnalyticsData()">
                            <i class="fas fa-trash"></i> Resetta Dati
                        </button>
                    </div>
                    
                    <div class="sync-section">
                        <h4>Stato Sincronizzazione</h4>
                        <div id="sync-status">
                            <div class="analytics-status">
                                <div class="status-indicator" id="sync-status-indicator">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="sync-status-text">Sincronizzato</span>
                                </div>
                                <div class="session-info">
                                    <div>Eventi in coda: <span id="pending-events-count">0</span></div>
                                    <div>Ultimo invio: <span id="last-send-time">Mai</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="sync-actions" style="margin-top: 10px;">
                            <button class="admin-btn primary" onclick="forceSyncAnalytics()">
                                <i class="fas fa-sync"></i> Forza Sincronizzazione
                            </button>
                            <button class="admin-btn secondary" onclick="clearAnalyticsErrors()">
                                <i class="fas fa-broom"></i> Pulisci Errori
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-debug-section">
                    <h4>Debug & Test</h4>
                    <div class="debug-controls">
                        <button class="admin-btn secondary" onclick="testAnalyticsEvent()">
                            <i class="fas fa-vial"></i> Test Evento
                        </button>
                        <button class="admin-btn secondary" onclick="testAnalyticsError()">
                            <i class="fas fa-bug"></i> Test Errore
                        </button>
                        <button class="admin-btn secondary" onclick="testPerformanceMetric()">
                            <i class="fas fa-tachometer-alt"></i> Test Performance
                        </button>
                    </div>
                    
                    <div class="debug-info">
                        <div class="info-item">
                            <span>Analytics Inizializzato:</span>
                            <span id="debug-initialized">No</span>
                        </div>
                        <div class="info-item">
                            <span>Firebase Analytics:</span>
                            <span id="debug-firebase">No</span>
                        </div>
                        <div class="info-item">
                            <span>Modalità PWA:</span>
                            <span id="debug-pwa">No</span>
                        </div>
                        <div class="info-item">
                            <span>Connessione:</span>
                            <span id="debug-online">No</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-tab-content" id="config-admin">
                <div class="config-section" style="border: 2px solid #ef4444; background: #fff1f2; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h4 style="color: #be123c; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 1.1rem;">
                        <i class="fas fa-satellite-dish"></i> Centro di Controllo Remoto
                    </h4>
                    
                    <div class="config-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #fecdd3;">
                        <div>
                            <label style="font-weight: bold; color: #881337; font-size: 1rem;">Modalità Manutenzione</label>
                            <p style="font-size: 0.85rem; color: #9f1239; margin-top: 4px;">Blocca l'app a tutti (tranne Admin).</p>
                        </div>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="global-maintenance-toggle" onchange="toggleGlobalMaintenance(this)">
                            <span class="slider round" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                            <style>.slider:before {position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;} input:checked + .slider {background-color: #ef4444;} input:checked + .slider:before {transform: translateX(26px);}</style>
                        </label>
                    </div>

                    <div class="config-item" style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px;">
                        <div>
                            <label style="font-weight: bold; color: #1e3a8a; font-size: 1rem;">Analytics & Privacy</label>
                            <p style="font-size: 0.85rem; color: #1e40af; margin-top: 4px;">
                                Stato: <span id="privacy-status-text" style="font-weight: bold;">Caricamento...</span>
                            </p>
                        </div>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="global-privacy-toggle" checked onchange="toggleGlobalAnalytics(this)">
                            <span class="slider round" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                            <style>input:checked + .slider {background-color: #3b82f6;}</style>
                        </label>
                    </div>
                </div>

                <div class="backup-section">
                    <h4>Sicurezza Account</h4>
                    <button class="admin-btn secondary" onclick="logoutAdmin()">
                        <i class="fas fa-sign-out-alt"></i> Logout Amministratore
                    </button>
                </div>
                
                <div class="import-export-section">
                    <h4>Export Dati Completo</h4>
                    <button class="admin-btn primary" onclick="exportAllDataToExcel()">
                        <i class="fas fa-file-excel"></i> Esporta Tutto in Excel
                    </button>
                </div>
            </div>
            </div>
    </div>

    <div class="app-container">
        <div class="admin-icon-btn-container">
            <button class="admin-icon-btn" onclick="toggleMenuModal()">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>

        <div class="screen active" id="home-screen">
            <div class="logo-container">
                <div class="app-logo logo-with-image"></div>
                <div class="comune-logo"></div>
            </div>
            
            <p class="home-welcome-animated">NAPOLI</p>
    
            <h1 class="home-title" id="home-title">Fontane & Beverini</h1>
    
            <p class="home-subtitle" id="home-subtitle">
                L'acqua pubblica a portata di app.
                Fontane e beverini della città di Napoli, sempre nel palmo della tua mano.
            </p>   
            
    
            <div class="home-buttons">
                <div class="button-row">
                    <button class="home-btn fontane-btn" onclick="showScreen('fontane-screen')">
                        <span class="btn-icon"><i class="fas fa-user-graduate"></i></span>
                        <span class="btn-text" id="nav-fontane">Filosofi</span>
                    </button>
                    
                    <button class="home-btn beverini-btn" onclick="showScreen('beverini-screen')">
                        <span class="btn-icon"><i class="fas fa-lightbulb"></i></span>
                        <span class="btn-text" id="nav-beverini">Concetti</span>
                    </button>
                </div>
                
                <div class="button-row">
                    <button class="home-btn mappa-btn" onclick="showScreen('mappa-screen')">
                        <span class="btn-icon"><i class="fas fa-map-marked-alt"></i></span>
                        <span class="btn-text" id="nav-map">Mappa</span>
                    </button>
                    
                    <button class="home-btn news-btn" onclick="showScreen('news-screen')">
                        <span class="btn-icon"><i class="fas fa-book"></i></span>
                        <span class="btn-text" id="nav-news">Glossario</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="screen list-screen" id="fontane-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        
                <h1 class="screen-title" id="fountains-title">Fontane</h1>
        
                <p class="screen-subtitle" id="fountains-subtitle">Scopri le fontane della città</p>
            </header>
    
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="🔍 Cerca fontane..." onkeyup="debouncedFilter('fontane', this.value)">
            </div>
    
            <div class="content-area">
                <div class="filter-buttons">
                    <button class="filter-btn all active trans-filter-all" onclick="setFilter('beverini', 'all')">
                        <i class="fas fa-layer-group"></i> Tutti
                    </button>
                    <button class="filter-btn funzionante trans-filter-working" onclick="setFilter('beverini', 'funzionante')">
                        <i class="fas fa-clock"></i> Contemporaneo
                    </button>
                    <button class="filter-btn non-funzionante trans-filter-broken" onclick="setFilter('beverini', 'non-funzionante')">
                        <i class="fas fa-landmark"></i> Classico
                    </button>
                    <button class="filter-btn manutenzione trans-filter-maintenance" onclick="setFilter('beverini', 'manutenzione')">
                        <i class="fas fa-scroll"></i> Moderno
                    </button>
               </div>
        
               <div class="items-grid" id="fontane-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    <p>Caricamento fontane in corso...</p>
                </div>
            </div> </div> </div> <div class="screen list-screen" id="beverini-screen">
        <header class="app-header">
            <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    
            <h1 class="screen-title" id="drinkers-title">Beverini</h1>
    
            <p class="screen-subtitle" id="drinkers-subtitle">Trova i beverini pubblici</p>
        </header>
    
            <div class="search-container">
                <input type="text" class="search-input" placeholder="🔍 Cerca beverini..." onkeyup="debouncedFilter('beverini', this.value)">
            </div>
    
            <div class="content-area">
                <div class="filter-buttons">
                    <button class="filter-btn all active trans-filter-all" onclick="setFilter('beverini', 'all')">
                        <i class="fas fa-layer-group"></i> Tutti
                    </button>
            
                    <button class="filter-btn funzionante trans-filter-working" onclick="setFilter('beverini', 'funzionante')">
                        <i class="fas fa-check-circle"></i> Funzionanti
                    </button>
            
                    <button class="filter-btn non-funzionante trans-filter-broken" onclick="setFilter('beverini', 'non-funzionante')">
                        <i class="fas fa-times-circle"></i> Non Funzionanti
                    </button>
            
                    <button class="filter-btn manutenzione trans-filter-maintenance" onclick="setFilter('beverini', 'manutenzione')">
                        <i class="fas fa-tools"></i> In Manutenzione
                    </button>
                </div>
        
                <div class="items-grid" id="beverini-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Caricamento beverini in corso...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen detail-screen" id="fontana-detail-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title" id="fontana-detail-title">Fontana</h1>
            </header>
            <div class="detail-content" id="fontana-detail-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            
        </div>

        <div class="screen detail-screen" id="beverino-detail-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title" id="beverino-detail-title">Beverino</h1>
            </header>
            <div class="detail-content" id="beverino-detail-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            
        </div>

        <div class="screen" id="mappa-screen">
            <header class="app-header" style="position: absolute; top: 0; left: 0; right: 0; z-index: 1000; padding: 15px 20px;">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title" id="map-title" style="font-size: 1.4rem;" data-i18n="screen_map">Mappa</h1>
            </header>
    
            <div class="map-search-container">
                <div class="map-search-box">
                    <input type="text" id="map-search-input" placeholder="🔍 Cerca indirizzo, luogo, punto interesse..."
                           onkeypress="handleMapSearch(event)">
                    <button class="map-search-btn" onclick="performMapSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="search-results" id="map-search-results"></div>
            </div>
    
            <div id="map" class="map-container"></div>
    
            <div class="map-legend">
                <div class="legend-title" id="legend-title">Legenda</div>
        
                <div class="legend-item">
                    <div class="legend-icon icon-fontana"></div>
                    <span id="legend-fontana">Fontana</span>
             </div>
        
             <div class="legend-item">
                 <div class="legend-icon icon-beverino"></div>
                 <span id="legend-beverino">Beverini</span>
             </div>
        
             <div class="legend-item">
                 <div class="legend-icon icon-position"></div>
                 <span id="legend-pos">La tua posizione</span>
             </div>
         </div>
    
         <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; z-index: 1000;">
             © <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors
         </div>
     </div>
     <div class="screen list-screen" id="news-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                
                <h1 class="screen-title" id="news-title">News</h1>
                
                <p class="screen-subtitle" id="news-subtitle">Ultime notizie sulle fontane</p>
            </header>
            
            <div class="content-area">
                <div class="news-container" id="news-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Caricamento news in corso...</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="segnalazioni-screen" class="screen">
            <div class="app-header" style="background: linear-gradient(135deg, #ef4444, #b91c1c);">
                <button class="back-btn" onclick="showScreen('home-screen')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="screen-title">Segnalazione</div>
            </div>

            <div class="content-area">
                <div class="report-form-container" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <p style="margin-bottom: 20px; color: #666; font-size: 0.95rem; line-height:1.5;">
                        Hai notato un problema? Compila il modulo. <br>
                        Si aprirà la tua app di posta per inviare una mail ufficiale a <b>ABC Napoli</b>.
                    </p>

                    <form onsubmit="inviaSegnalazione(event)">
                        <div class="form-group" style="margin-bottom:20px;">
                            <label style="font-weight:600; display:block; margin-bottom:8px;">Tipo segnalazione</label>
                            <select id="report-type" class="form-input" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; background: #f9f9f9;">
                                <option value="Guasto">Guasto / Non eroga acqua</option>
                                <option value="Perdita">Perdita d'acqua</option>
                                <option value="Sporcizia">Pulizia/Manutenzione</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin-bottom:25px;">
                            <label style="font-weight:600; display:block; margin-bottom:8px;">Descrizione e Posizione</label>
                            <textarea id="report-desc" rows="5" placeholder="Esempio: La fontanella in Piazza Plebiscito perde acqua dalla base..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; background: #f9f9f9; font-family:inherit; resize:none;"></textarea>
                        </div>

                        <button type="submit" style="width:100%; padding:15px; background: linear-gradient(135deg, #ef4444, #b91c1c); color:white; border:none; border-radius:12px; font-weight:700; font-size:1.1rem; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);">
                            <i class="fas fa-paper-plane"></i> INVIA EMAIL
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="tab-bar">
                <button class="tab-btn" onclick="showScreen('home-screen')"><span class="tab-icon"><i class="fas fa-home"></i></span><span>Home</span></button>
                <button class="tab-btn" onclick="showScreen('fontane-screen')"><span class="tab-icon"><i class="fas fa-monument"></i></span><span>Fontane</span></button>
                <button class="tab-btn" onclick="showScreen('beverini-screen')"><span class="tab-icon"><i class="fas fa-faucet"></i></span><span>Beverini</span></button>
                <button class="tab-btn" onclick="showScreen('mappa-screen')"><span class="tab-icon"><i class="fas fa-map-marked-alt"></i></span><span>Mappa</span></button>
                <button class="tab-btn" onclick="showScreen('news-screen')"><span class="tab-icon"><i class="fas fa-newspaper"></i></span><span>News</span></button>
            </div>
        </div>

        <div id="credits-screen" class="screen">
            <div class="app-header" style="background: linear-gradient(135deg, #1e3a8a, #3b82f6);">
                <button class="back-btn" onclick="showScreen('home-screen')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="screen-title" style="font-size: 1.4rem;">Info & Credits</div>
            </div>

            <div class="content-area" style="text-align: center; padding: 30px 20px;">
                
                <div style="margin-bottom: 30px;">
                    <img src="./images/logo-app.png" alt="ABC Napoli" style="width: 80px; height: 80px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px;">
                    <h2 style="font-size: 1.3rem; color: var(--dark-text); margin-bottom: 5px;">ABC Napoli F&B</h2>
                    <p style="color: var(--light-text); font-size: 0.9rem;">v. 1.0.0</p>
                </div>

                <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 20px 0;">

                <div class="credit-section" style="margin-bottom: 25px;">
                    <h4 style="color: var(--primary-blue); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">SOFTWARE DEVELOPMENT & DESIGN</h4>
                    <p style="font-size: 0.8rem; color: #6b7280; font-style: italic; margin-bottom: 5px;">(Sviluppo tecnico, programmazione e design etico)</p>
                    <p style="font-weight: 700; font-size: 1rem; color: #1f2937;">Salvatore De Rosa</p>
                    <p style="font-size: 0.9rem; color: #4b5563;">Full Stack Developer & Ethical Design Lead</p>
                </div>

                <div class="credit-section" style="margin-bottom: 25px;">
                    <h4 style="color: var(--primary-blue); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">DATA MANAGEMENT & OPERATIONS</h4>
                    <p style="font-size: 0.8rem; color: #6b7280; font-style: italic; margin-bottom: 5px;">(Gestione operativa della verifica dati sul territorio)</p>
                    <p style="font-weight: 700; font-size: 1rem; color: #1f2937;">Luigi Di Nunzio</p>
                    <p style="font-size: 0.9rem; color: #4b5563;">Data Analyst Strategy</p>
                    <p style="font-size: 0.8rem; color: #6b7280;">(B.A. International Relations)</p>
                </div>

                <div class="credit-section" style="margin-bottom: 30px;">
                    <h4 style="color: var(--primary-blue); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">INSTITUTIONAL SUPERVISION</h4>
                    <p style="font-size: 0.8rem; color: #6b7280; font-style: italic; margin-bottom: 5px;">(Coordinamento dell'iniziativa e supervisione)</p>
                    <p style="font-weight: 700; font-size: 1rem; color: #1f2937;">Dott. Attilio De Pasquale</p>
                    <p style="font-size: 0.9rem; color: #4b5563;">Head of Ufficio Supporto Tecnico</p>
                    <p style="font-size: 0.85rem; color: #4b5563;">(Project Supervisor)</p>
                </div>

                <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 20px 0;">

                <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.5;">
                    <p style="margin-bottom: 10px;">Applicativo software realizzato <strong>a titolo gratuito</strong> su iniziativa del <strong>gruppo di lavoro</strong> e <strong>concesso in licenza d'uso</strong> all'Azienda Speciale ABC Napoli per esclusive finalità di pubblico servizio.</p>
                    <p style="font-weight: 600; color: #ef4444; margin-bottom: 15px;">Vietato l'uso commerciale.</p>
                    
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                        <p style="font-weight: 600; margin-bottom: 8px; color: #4b5563;">Technologies & Services:</p>
                        <p>Leaflet Maps, OpenStreetMap Data</p>
                        <p>Google Firebase, Google Fonts</p>
                        <p>Dev & Version Control: <strong>GitHub</strong></p>
                        <p>Image Hosting: <strong>ImgBB</strong></p>
                    </div>
                    
                    <p style="margin-top: 15px; line-height: 1.4;">
                        Software © 2026 <strong>Salvatore De Rosa</strong>.<br>
                        &copy; 2026 <strong>Gruppo di Lavoro</strong>.<br>
                        <span style="font-size: 0.85em; opacity: 0.8; font-weight: 400;">Concesso in licenza d'uso.</span>
                    </p>
                </div>

                <div style="height: 120px;"></div>
            </div>
        </div>
        

        <div class="tab-bar">
            <button class="tab-btn active" data-target="home-screen" onclick="showScreen('home-screen')">
                <span class="tab-icon"><i class="fas fa-home"></i></span>
                <span data-i18n="tab_home">Home</span>
            </button>
            <button class="tab-btn" data-target="fontane-screen" onclick="showScreen('fontane-screen')">
                <span class="tab-icon"><i class="fas fa-monument"></i></span>
                <span data-i18n="tab_fountains">Fontane</span>
            </button>
            <button class="tab-btn" data-target="beverini-screen" onclick="showScreen('beverini-screen')">
                <span class="tab-icon"><i class="fas fa-faucet"></i></span>
                <span data-i18n="tab_drinkers">Beverini</span>
            </button>
            <button class="tab-btn" data-target="mappa-screen" onclick="showScreen('mappa-screen')">
                <span class="tab-icon"><i class="fas fa-map-marked-alt"></i></span>
                <span data-i18n="tab_map">Mappa</span>
            </button>
            <button class="tab-btn" data-target="news-screen" onclick="showScreen('news-screen')">
                <span class="tab-icon"><i class="fas fa-newspaper"></i></span>
                <span data-i18n="tab_news">News</span>
            </button>
        </div>

        <button class="fixed-navigate-btn hidden" id="fixed-navigate-btn" onclick="navigateToFixed()">
            <i class="fas fa-map-marker-alt"></i> <span id="nav-btn-text">Naviga Verso</span>
        </button>
        </div>
    <div id="top-menu-modal" class="modal-overlay" onclick="closeMenuModal(event)" style="z-index: 9999;">
        <div class="modal-content menu-modal-content" style="width: 280px; padding: 20px; position: absolute; top: 70px; right: 20px;">
            <h3 class="modal-title" style="margin-bottom: 20px; font-size:1.2rem;">Menu</h3>
            
            <div class="modal-buttons">
                <button class="modal-btn lang-switch" onclick="toggleLanguage()">
                    <span id="lang-flag">🇬🇧</span> 
                    <span id="lang-label">Switch to English</span>
                </button>

                <button class="modal-btn primary" onclick="openReportScreen()" style="background: #ef4444;">
                    <i class="fas fa-bullhorn"></i> <span data-i18n="report_btn">Invia Segnalazione</span>
                </button>
                
                <button class="modal-btn primary" onclick="openCreditsScreen()" style="background: #3b82f6;">
                    <i class="fas fa-info-circle"></i> <span data-i18n="info_btn">Info & Crediti</span>
                </button>
                
                <button class="modal-btn secondary" onclick="goToAdmin()">
                    <i class="fas fa-user-shield"></i> <span data-i18n="admin_btn">Area Riservata</span>
                </button>

                <button class="modal-btn" onclick="openQRModal()" style="margin-top: 10px; background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd;">
                    <i class="fas fa-qrcode"></i> <span data-i18n="btn_qr">Condividi App</span>
                </button>
                <button class="modal-btn" onclick="toggleMenuModal()" style="border: 1px solid #ddd; background:white; margin-top:10px;">
                    <span data-i18n="btn_close">Chiudi</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script src="./translations.js"></script>
    
    <script src="./app.js"></script>
    
    <script src="./analytics.js" defer></script>
    
    <script>
        // SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swUrl = './sw.js';
                fetch(swUrl, { mode: 'no-cors' })
                  .then(response => {
                      return navigator.serviceWorker.register(swUrl)
                          .then(registration => {
                              console.log('✅ Service Worker registrato:', registration.scope);
                              registration.addEventListener('updatefound', () => {
                                  const newWorker = registration.installing;
                                  newWorker.addEventListener('statechange', () => {
                                      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                          showToast('Nuova versione disponibile! Ricarica la pagina.', 'info');
                                      }
                                  });
                              });
                              return registration;
                          });
                  })
                  .catch(error => {
                      console.warn('⚠️ Registrazione SW fallita:', error.message);
                  });
            });
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
        });
        
        // FUNZIONI ANALYTICS
        function refreshAnalyticsDashboard() {
            if (window.Analytics) {
                const summary = window.Analytics.getAnalyticsSummary();
                document.getElementById('analytics-session-count').textContent = summary.sessions.today || '0';
                document.getElementById('analytics-events-count').textContent = summary.events.today || '0';
                document.getElementById('analytics-pageviews-count').textContent = summary.pageViews.today || '0';
                document.getElementById('analytics-errors-count').textContent = summary.errors.today || '0';
                document.getElementById('metric-page-load').textContent = Math.round(summary.metrics.performance.average || 0) + 'ms';
                document.getElementById('metric-image-load').textContent = Math.round(summary.metrics.performance.imageLoad || 0) + 'ms';
                document.getElementById('metric-data-load').textContent = '0ms';
                document.getElementById('storage-events').textContent = summary.events.total || '0';
                document.getElementById('storage-errors').textContent = summary.errors.total || '0';
                document.getElementById('storage-used').textContent = Math.round(summary.metrics.storage.eventsSize / 1024) + ' KB';
                document.getElementById('current-session-id').textContent = summary.sessions.current.id.substring(0, 15) + '...';
                document.getElementById('current-user-id').textContent = summary.user.id.substring(0, 15) + '...';
                
                const statusIndicator = document.getElementById('analytics-status-indicator');
                const statusText = document.getElementById('analytics-status-text');
                
                if (window.Analytics.config.trackingEnabled) {
                    statusIndicator.classList.remove('inactive');
                    statusIndicator.classList.add('active');
                    statusText.textContent = 'Analytics Attivo';
                    statusText.className = 'status-active';
                } else {
                    statusIndicator.classList.remove('active');
                    statusIndicator.classList.add('inactive');
                    statusText.textContent = 'Analytics Disattivo';
                    statusText.className = 'status-inactive';
                }
                
                document.getElementById('debug-initialized').textContent = window.Analytics.isInitialized ? 'Si' : 'No';
                document.getElementById('debug-firebase').textContent = window.firebaseAnalytics ? 'Si' : 'No';
                document.getElementById('debug-pwa').textContent = window.matchMedia('(display-mode: standalone)').matches ? 'Si' : 'No';
                document.getElementById('debug-online').textContent = navigator.onLine ? 'Si' : 'No';
                
                showToast('Dashboard analytics aggiornata', 'success');
                window.Analytics.trackEvent('analytics', 'dashboard_refreshed');
            } else {
                showToast('Analytics non inizializzato', 'error');
            }
        }
        
        function exportAnalyticsData() {
            if (window.Analytics) {
                const filename = window.Analytics.exportAnalyticsData();
                showToast(`Dati analytics esportati in ${filename}`, 'success');
                window.Analytics.trackEvent('analytics', 'data_exported');
            }
        }
        
        function resetAnalyticsData() {
            if (confirm('Sei sicuro di voler resettare tutti i dati analytics?')) {
                if (window.Analytics) {
                    window.Analytics.resetUserData();
                    refreshAnalyticsDashboard();
                    showToast('Dati analytics resettati', 'success');
                    window.Analytics.trackEvent('analytics', 'data_reset');
                }
            }
        }
        
        function toggleAnalyticsTracking() {
            if (window.Analytics) {
                const newState = !window.Analytics.config.trackingEnabled;
                window.Analytics.setTrackingEnabled(newState);
                refreshAnalyticsDashboard();
            }
        }
        
        function forceSyncAnalytics() {
            if (window.Analytics && window.Analytics.flushQueue) {
                window.Analytics.flushQueue(true);
                localStorage.setItem('analytics_last_sync', new Date().toISOString());
                refreshAnalyticsDashboard();
                showToast('Sync analytics forzato', 'info');
            }
        }
        
        function clearAnalyticsErrors() {
            if (confirm('Cancellare tutti gli errori registrati?')) {
                localStorage.removeItem('analytics_errors');
                refreshAnalyticsDashboard();
                showToast('Errori cancellati', 'success');
            }
        }
        
        function testAnalyticsEvent() {
            if (window.Analytics) {
                window.Analytics.trackEvent('test', 'manual_event', 'Test manuale', 1, { test_mode: true });
                showToast('Evento test registrato', 'info');
                refreshAnalyticsDashboard();
            }
        }
        
        function testAnalyticsError() {
            if (window.Analytics) {
                const testError = new Error('Errore di test manuale');
                window.Analytics.trackError(testError, 'test_manual', 'low', { test_mode: true });
                showToast('Errore test registrato', 'info');
                refreshAnalyticsDashboard();
            }
        }
        
        function testPerformanceMetric() {
            if (window.Analytics) {
                const loadTime = Math.random() * 1000 + 500;
                window.Analytics.trackPerformance('test_manual_load', loadTime);
                showToast(`Metrica test: ${Math.round(loadTime)}ms`, 'info');
                refreshAnalyticsDashboard();
            }
        }
        
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                if (tabId === 'analytics-admin') {
                    setTimeout(() => {
                        refreshAnalyticsDashboard();
                        setTimeout(createActivityChart, 500);
                    }, 100);
                }
            });
        });
        
        function createActivityChart() {
            const canvas = document.getElementById('activity-chart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            if (window.activityChart) window.activityChart.destroy();
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('it-IT', { weekday: 'short' }));
                data.push(Math.floor(Math.random() * 50) + 20);
            }
            window.activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Eventi',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.Analytics) refreshAnalyticsDashboard();
            }, 2000);
        });
    </script>

    <div id="qr-modal" class="modal-overlay" style="display: none; align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-content" style="text-align: center; max-width: 300px; padding: 25px; border-radius: 20px;">
            <h3 class="modal-title" data-i18n="qr_title" style="margin-bottom: 15px;">Scarica l'App</h3>
            
            <div id="qrcode-container" style="display: flex; justify-content: center; margin: 20px auto; padding: 10px; background: white; border-radius: 10px;"></div>
            
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px; line-height: 1.4;" data-i18n="qr_subtitle">
                Fai scansionare questo codice per aprire l'app.
            </p>
            
            <button class="modal-btn" onclick="closeQRModal()" style="width: 100%; padding: 12px; background: #e2e8f0; border: none; border-radius: 12px; font-weight: 600;">
                <span data-i18n="btn_close">Chiudi</span>
            </button>
        </div>
    </div>

    <div id="smart-install-banner" class="install-banner" style="display: none;">
        <div class="install-text">
            <span class="install-title" data-i18n="install_title">Installa ABC Napoli</span>
            <span class="install-subtitle" data-i18n="install_subtitle">Per mappe offline e notifiche</span>
        </div>
        <button id="smart-install-btn" class="install-action-btn" data-i18n="install_btn">
            Installa
        </button>
        <button class="install-close-btn" onclick="document.getElementById('smart-install-banner').style.display='none'">
            <i class="fas fa-times"></i>
        </button>
    </div>
    </body>
</html>